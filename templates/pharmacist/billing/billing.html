{% extends "pharmacist/base.html" %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    .medicine-item {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
    }

    .medicine-item:hover {
        background-color: #f8f9fa;
    }

    .add-btn {
        width: 35px;
        height: 35px;
        border-radius: 50%;
    }
</style>

<h3 class="mb-4">ðŸ’Š Pharmacy Billing</h3>
<div class="container-fluid">
    <div class="row">
        <!-- LEFT: Medicines -->
        <div class="col-md-6">
            <h4>ðŸ’Š Select Medicines</h4>
            <input type="text" id="search" class="form-control mb-3" placeholder="Search medicines...">

            {% for medicine in medicines %}
            <div class="medicine-item" data-id="{{ medicine.id }}">
                <div>
                    <h6 class="medicine-name">{{ medicine.name }}</h6>
                    <small>Stock: {{ medicine.stock_qty }}</small>
                </div>
                <div>
                    <strong class="medicine-price">${{ medicine.price }}</strong>
                    <button class="btn btn-dark add-btn ms-2">+</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- RIGHT: Billing Section -->
        <div class="col-md-6">
            <h4>ðŸ§¾ Current Bill</h4>
            <div class="mb-3">
                <label>Customer Name</label>
                <input type="text" id="customerName" class="form-control">
            </div>
            <div class="mb-3">
                <label>Phone Number (optional)</label>
                <input type="text" id="phoneNumber" class="form-control">
            </div>

            <table class="table table-bordered text-center">
                <thead class="table-light">
                    <tr>
                        <th>S.N</th>
                        <th>Item</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="cart-items"></tbody>
            </table>

            <div class="mt-3">
                <p>Subtotal: <span id="subtotal">$0.00</span></p>
                <p>Tax (13%): <span id="tax">$0.00</span></p>
                <h5>Total: <span id="total">$0.00</span></h5>
            </div>

            <div class="mt-4">
                <label>Payment Method</label>
                <select id="paymentMethod" class="form-select">
                    <option value="">Select Method</option>
                    <option value="cash">Cash</option>
                    <option value="card">Card</option>
                    <option value="esewa">eSewa</option>
                </select>
            </div>

            <!-- Cash fields (hidden unless cash selected) -->
            <div id="cashFields" class="mt-3" style="display:none;">
                <label>Amount Received</label>
                <input type="number" id="amountReceived" class="form-control mb-2" placeholder="Enter amount received">
                <label>Return Amount</label>
                <input type="text" id="returnAmount" class="form-control" readonly>
            </div>

            <button id="generateInvoiceBtn" class="btn btn-success w-100 mt-4">ðŸ§¾ Generate Invoice</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const addButtons = document.querySelectorAll(".add-btn");
        const cartTableBody = document.querySelector("#cart-items");
        const subtotalEl = document.querySelector("#subtotal");
        const taxEl = document.querySelector("#tax");
        const totalEl = document.querySelector("#total");
        const paymentMethod = document.querySelector("#paymentMethod");
        const cashFields = document.querySelector("#cashFields");
        const amountReceived = document.querySelector("#amountReceived");
        const returnAmount = document.querySelector("#returnAmount");
        const generateBtn = document.querySelector("#generateInvoiceBtn");

        let cart = [];

        function updateCart() {
            cartTableBody.innerHTML = "";
            let subtotal = 0;

            cart.forEach((item, index) => {
                const itemTotal = item.price * item.qty;
                subtotal += itemTotal;

                const row = document.createElement("tr");
                row.innerHTML = `
              <td>${index + 1}</td>
              <td>${item.name}</td>
              <td>
                <button class="btn btn-sm btn-outline-secondary decrease" data-index="${index}">-</button>
                <span class="mx-2">${item.qty}</span>
                <button class="btn btn-sm btn-outline-secondary increase" data-index="${index}">+</button>
              </td>
              <td>$${item.price.toFixed(2)}</td>
              <td>$${itemTotal.toFixed(2)}</td>
              <td><button class="btn btn-sm btn-danger remove" data-index="${index}">Ã—</button></td>
            `;
                cartTableBody.appendChild(row);
            });

            const tax = subtotal * 0.13;
            const total = subtotal + tax;

            subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            taxEl.textContent = `$${tax.toFixed(2)}`;
            totalEl.textContent = `$${total.toFixed(2)}`;

            if (paymentMethod.value === "cash" && amountReceived.value) {
                const received = parseFloat(amountReceived.value);
                const change = received - total;
                returnAmount.value = change >= 0 ? `$${change.toFixed(2)}` : "Insufficient";
            }
        }

        addButtons.forEach(button => {
            button.addEventListener("click", () => {
                const medicineDiv = button.closest(".medicine-item");
                const id = parseInt(medicineDiv.dataset.medicine_id); // FIX: Convert to integer
                const name = medicineDiv.querySelector(".medicine-name").textContent.trim();
                const price = parseFloat(medicineDiv.querySelector(".medicine-price").textContent.replace("$", ""));

                const existing = cart.find(item => item.id === id);
                if (existing) {
                    existing.qty += 1;
                } else {
                    cart.push({ id, name, price, qty: 1 });
                }
                updateCart();
            });
        });

        cartTableBody.addEventListener("click", (e) => {
            const index = e.target.dataset.index;
            if (e.target.classList.contains("increase")) cart[index].qty++;
            else if (e.target.classList.contains("decrease")) cart[index].qty > 1 ? cart[index].qty-- : cart.splice(index, 1);
            else if (e.target.classList.contains("remove")) cart.splice(index, 1);
            updateCart();
        });

        paymentMethod.addEventListener("change", () => {
            if (paymentMethod.value === "cash") cashFields.style.display = "block";
            else {
                cashFields.style.display = "none";
                amountReceived.value = "";
                returnAmount.value = "";
            }
        });

        amountReceived.addEventListener("input", updateCart);

        // âœ… Generate Invoice
        generateBtn.addEventListener("click", async () => {
            const customerName = document.querySelector("#customerName").value.trim();
            const phoneNumber = document.querySelector("#phoneNumber").value.trim();
            const method = paymentMethod.value;
            const received = amountReceived.value;
            const returned = returnAmount.value;
            const subtotal = parseFloat(subtotalEl.textContent.replace("$", ""));
            const tax = parseFloat(taxEl.textContent.replace("$", ""));
            const total = parseFloat(totalEl.textContent.replace("$", ""));

            if (!customerName || !method || cart.length === 0) {
                alert("Please fill customer name, select payment method, and add items.");
                return;
            }
            const response = await fetch("/billing/generate-invoice/", {

                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({
                    customerName,
                    phoneNumber,
                    paymentMethod: method,
                    amountReceived: received,
                    returnAmount: returned,
                    subtotal,
                    tax,
                    total,
                    items: cart
                })
            });

            const data = await response.json();
          console.log(data);

        });

        // Helper for CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
</body>

</html>
{% endblock %}