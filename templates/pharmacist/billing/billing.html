{% extends 'base.html' %}
{% block title %}Billing - Pharmacy Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3">
                <i class="bi bi-calculator"></i> Billing Systemmm
            </h1>
            <p class="text-muted">Create new invoices and manage sales</p>
        </div>
    </div>

    <div class="row">
        <!-- Medicine Selection -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-capsule"></i> Available Medicines
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for medicine in medicines %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card medicine-item" data-id="{{ medicine.medicine_id }}" style="border: 1px solid var(--border-color);">
                                <div class="card-body">
                                    <h6 class="medicine-name">{{ medicine.name }}</h6>
                                    <p class="text-muted mb-2">{{ medicine.brand_name }}</p>
                                    <p class="medicine-price text-primary fw-bold">NRS {{ medicine.price|floatformat:2 }}</p>
                                    <p class="text-muted small">Stock: {{ medicine.stock_qty }}</p>
                                    <button class="btn btn-primary btn-sm add-to-cart w-100">
                                        <i class="bi bi-plus"></i> Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart and Customer Info -->
        <div class="col-lg-4">
            <!-- Customer Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person"></i> Customer Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="customerName" class="form-label">Customer Name *</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="phoneNumber">
                    </div>
                </div>
            </div>

            <!-- Cart -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-cart"></i> Cart Items
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="cart-items"></tbody>
                    </table>

                    <div class="mt-3">
                        <p>Subtotal: <span id="subtotal">NRS 0.00</span></p>
                        <p>Tax (13%): <span id="tax">NRS 0.00</span></p>
                        <h5>Total: <span id="total">NRS 0.00</span></h5>
                    </div>

                    <div class="mt-4">
                        <label class="form-label">Payment Method</label>
                        <select id="paymentMethod" class="form-select">
                            <option value="">Select Method</option>
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="upi">UPI</option>
                        </select>
                    </div>

                    <div id="cashFields" class="mt-3" style="display: none;">
                        <div class="mb-3">
                            <label for="amountReceived" class="form-label">Amount Received</label>
                            <input type="number" class="form-control" id="amountReceived" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="returnAmount" class="form-label">Return Amount</label>
                            <input type="text" class="form-control" id="returnAmount" readonly>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button id="generateInvoice" class="btn btn-success">
                            <i class="bi bi-receipt"></i> Generate Invoice
                        </button>
                        <button id="clearCart" class="btn btn-outline-secondary">
                            <i class="bi bi-trash"></i> Clear Cart
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let cart = [];
    const cartTableBody = document.getElementById('cart-items');
    const subtotalEl = document.getElementById('subtotal');
    const taxEl = document.getElementById('tax');
    const totalEl = document.getElementById('total');
    const paymentMethod = document.getElementById('paymentMethod');
    const amountReceived = document.getElementById('amountReceived');
    const returnAmount = document.getElementById('returnAmount');
    const cashFields = document.getElementById('cashFields');
    const addButtons = document.querySelectorAll('.add-to-cart');

    // Payment method change handler
    paymentMethod.addEventListener('change', function() {
        if (this.value === 'cash') {
            cashFields.style.display = 'block';
        } else {
            cashFields.style.display = 'none';
        }
        updateTotals();
    });

    // Amount received change handler
    amountReceived.addEventListener('input', updateTotals);

    function updateTotals() {
        let subtotal = 0;
        cart.forEach(item => {
            subtotal += item.price * item.qty;
        });

        const tax = subtotal * 0.13;
        const total = subtotal + tax;

        subtotalEl.textContent = `NRS ${subtotal.toFixed(2)}`;
        taxEl.textContent = `NRS ${tax.toFixed(2)}`;
        totalEl.textContent = `NRS ${total.toFixed(2)}`;

        if (paymentMethod.value === 'cash' && amountReceived.value) {
            const received = parseFloat(amountReceived.value);
            const change = received - total;
            returnAmount.value = change >= 0 ? `NRS ${change.toFixed(2)}` : "Insufficient";
        }
    }

    function renderCart() {
        cartTableBody.innerHTML = '';
        cart.forEach((item, index) => {
            const itemTotal = item.price * item.qty;
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.name}</td>
              <td>
                <button class="btn btn-sm btn-outline-secondary decrease" data-index="${index}">-</button>
                <span class="mx-2">${item.qty}</span>
                <button class="btn btn-sm btn-outline-secondary increase" data-index="${index}">+</button>
              </td>
              <td>NRS ${item.price.toFixed(2)}</td>
              <td>NRS ${itemTotal.toFixed(2)}</td>
              <td><button class="btn btn-sm btn-danger remove" data-index="${index}">Ã—</button></td>
            `;
            cartTableBody.appendChild(row);
        });

        // Add event listeners to cart buttons
        document.querySelectorAll('.decrease').forEach(button => {
            button.addEventListener('click', (e) => {
                const index = parseInt(e.target.dataset.index);
                if (cart[index].qty > 1) {
                    cart[index].qty--;
                } else {
                    cart.splice(index, 1);
                }
                renderCart();
                updateTotals();
            });
        });

        document.querySelectorAll('.increase').forEach(button => {
            button.addEventListener('click', (e) => {
                const index = parseInt(e.target.dataset.index);
                cart[index].qty++;
                renderCart();
                updateTotals();
            });
        });

        document.querySelectorAll('.remove').forEach(button => {
            button.addEventListener('click', (e) => {
                const index = parseInt(e.target.dataset.index);
                cart.splice(index, 1);
                renderCart();
                updateTotals();
            });
        });

        updateTotals();
    }

    addButtons.forEach(button => {
        button.addEventListener('click', () => {
            const medicineDiv = button.closest('.medicine-item');
            const id = parseInt(medicineDiv.dataset.id);
            const name = medicineDiv.querySelector('.medicine-name').textContent.trim();
            const price = parseFloat(medicineDiv.querySelector('.medicine-price').textContent.replace('NRS ', ''));

            const existing = cart.find(item => item.id === id);
            if (existing) {
                existing.qty += 1;
            } else {
                cart.push({ id, name, price, qty: 1 });
            }
            renderCart();
        });
    });

    // Generate Invoice
    document.getElementById('generateInvoice').addEventListener('click', async () => {
        const customerName = document.querySelector('#customerName').value.trim();
        const phoneNumber = document.querySelector('#phoneNumber').value.trim();
        const method = paymentMethod.value;
        const received = amountReceived.value.trim();
        const returned = returnAmount.value.trim();
        const subtotal = parseFloat(subtotalEl.textContent.replace('NRS ', ''));
        const tax = parseFloat(taxEl.textContent.replace('NRS ', ''));
        const total = parseFloat(totalEl.textContent.replace('NRS ', ''));

        if (!customerName || !method || cart.length === 0) {
            alert('Please fill customer name, select payment method, and add items.');
            return;
        }

        const invoiceData = {
            customer_name: customerName,
            phone_number: phoneNumber || null,
            payment_method: method,
            amount_received: received || null,
            return_amount: returned || null,
            subtotal: subtotal,
            tax: tax,
            total: total,
            items: cart
        };

        try {
            const response = await fetch('{% url "generate_invoice" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(invoiceData)
            });

            const data = await response.json();
            if (data.success) {
                alert(`Invoice generated successfully! Invoice ID: ${data.invoice_id}`);
                if (data.invoice_id) {
                    window.location.href = `/billing/invoice/${data.invoice_id}/`;
                }
                // Reset form
                cart = [];
                renderCart();
                document.querySelector('#customerName').value = '';
                document.querySelector('#phoneNumber').value = '';
                paymentMethod.value = '';
                amountReceived.value = '';
                returnAmount.value = '';
                cashFields.style.display = 'none';
            } else {
                alert(`Error generating invoice: ${data.error}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error generating invoice. Please try again.');
        }
    });

    // Clear Cart
    document.getElementById('clearCart').addEventListener('click', () => {
        cart = [];
        renderCart();
        document.querySelector('#customerName').value = '';
        document.querySelector('#phoneNumber').value = '';
        paymentMethod.value = '';
        amountReceived.value = '';
        returnAmount.value = '';
        cashFields.style.display = 'none';
    });
</script>
{% endblock %}
