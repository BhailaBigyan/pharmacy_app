{% extends 'base.html' %}
{% block title %}Invoice #{{ invoice.invoice_id }} - Pharmacy Management{% endblock %}

{% block content %}
<div class="container-fluid">
    {# 1. Print-Only Company Header (Visible only when printing) #}
    <div class="row mb-4 d-none d-print-block print-company-header">
        <div class="col-12 text-center mb-4">
            <h2 class="mb-1">üè• HealthyLife Pharmacy üíä</h2>
            <p class="mb-0">123 Main St, Kathmandu, Nepal</p>
            <p class="mb-0">Phone: +977-9841000000</p>
            <p class="mb-0">VAT No: 600123456 | PAN No: 301000000</p>
            <h3 class="mt-4 mb-0 text-uppercase bill-title">BILL</h3>
            <hr class="w-25 mx-auto mt-1 mb-4" style="border-top: 2px solid #333;">
        </div>
    </div>

    {# Screen View Invoice Header (Hidden when printing) #}
    <div class="row mb-4 d-print-none">
        <div class="col-12">
            <h1 class="mb-3">
                <i class="bi bi-receipt"></i> Invoice #{{ invoice.invoice_id }}
            </h1>
            <p class="text-muted">Generated on {{ invoice.created_at|date:"F d, Y \a\t H:i" }}</p>
        </div>
    </div>

    {# --- PRINT LAYOUT CONTAINER (FIXED FOR PRINTING) --- #}
    <div class="row print-main-content">
        
        {# LEFT COLUMN: DETAILS & ITEMS (70% in Print) #}
        <div class="col-lg-8 print-left-content">
            <div class="card invoice-details-card">
                <div class="card-header d-print-none">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Invoice Details
                    </h5>
                </div>
                <div class="card-body print-details-body">
                    <div class="row">
                        <div class="col-md-12 col-print-left">
                            <h6>BILLED TO:</h6>
                            <p class="mb-1">Name: {{ invoice.customer_name }}</p>
                            {% if invoice.phone_number %}
                            <p class="mb-1">Phone: {{ invoice.phone_number }}</p>
                            {% endif %}
                            {% if invoice.email_address %}
                            <p class="mb-1">Email: {{ invoice.email_address }}</p>
                            {% endif %}
                            
                            <p class="mb-1">INVOICE: INV-{{ invoice.invoice_id }}</p>
                            <p class="mb-1">Date: {{ invoice.created_at|date:"d M Y" }}</p>
                        </div>
                    </div>
                </div>
            </div}
            <div class="card mt-4 items-card">
                <div class="card-header d-print-none">
                    <h5 class="mb-0">
                        <i class="bi bi-list"></i> Items
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table print-items-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Unit Price (NRS)</th>
                                <th>Total Price (NRS)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in invoice.items.all %}
                            <tr>
                                <td>{{ item.medicine.name }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ item.price|floatformat:2 }}</td>
                                <td>{{ item.total|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                            {% for _ in 1|ljust:5 %}
                            <tr>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {# RIGHT COLUMN: SUMMARY & ACTIONS #}
        <div class="col-lg-4 summary-col-print">
            
            {# 3. Summary Card (Visible on Screen AND styled for Print) #}
            <div class="card mt-4 summary-card-print">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-calculator"></i> Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <span>Subtotal:</span>
                        <span>NRS {{ invoice.subtotal|floatformat:2 }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Discount:</span>
                        <span>NRS {{ invoice.discount|floatformat:2 }}</span>
                    </div>
                    <hr class="d-print-none"> 
                    <div class="d-flex justify-content-between total-row">
                        <span>TOTAL:</span>
                        <span>NRS {{ invoice.total|floatformat:2 }}</span>
                    </div>
                </div>
            </div}
            {# 4. Actions Card (Visible on Screen ONLY) #}
            <div class="card mt-4 actions-card d-print-none">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-gear"></i> Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button onclick="window.print()" class="btn btn-primary">
                            <i class="bi bi-printer"></i> Print Invoice
                        </button>
                        <a href="{% url 'billing:bill' %}" class="btn btn-success">
                            <i class="bi bi-plus"></i> New Bill
                        </a>
                        <a href="{% url 'billing:sales_report' %}" class="btn btn-outline-primary">
                            <i class="bi bi-graph-up"></i> Sales Report
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {# 5. Bottom Info (Billed By / Thank You) - Hidden on Screen, Visible on Print #}
    <div class="row mt-4 print-bottom-info d-none d-print-flex">
        <div class="col-md-6 col-print-left">
            <h6 class="mb-1">PAYMENT INFORMATION:</h6>
            <p class="mb-1">Method: {{ invoice.get_payment_method_display }}</p>
            <p class="mb-1">Billed By: {{ invoice.billed_by }}</p>
        </div>
        <div class="col-md-6 col-print-right text-end">
            <p class="mb-1">Thank you for shopping at HealthyLife Pharmacy!</p>
            <p class="mb-1">Visit us again soon!</p>
        </div>
    </div>
</div>

<style media="print">
    /* --- General Print Setup --- */
    body {
        font-family: Arial, sans-serif;
        font-size: 12px;
        color: #000;
        background: #fff !important;
        margin: 0;
        padding: 0;
    }
    
    .container-fluid {
        max-width: 800px;
        margin: 20px auto;
        padding: 0;
        border: 1px solid #000; /* Main border for the bill */
    }

    /* Hide screen elements */
    .d-print-none, .actions-card, .card-header, .btn, .nav, .header, .footer {
        display: none !important;
    }

    /* Show print elements */
    .d-print-block { display: block !important; }
    .d-print-flex { display: flex !important; }

    /* --- Company Header Styling --- */
    .print-company-header {
        margin-top: 20px !important;
        padding-bottom: 0 !important;
        border-bottom: 1px solid #000; /* Separator for company header */
    }
    .bill-title {
        font-size: 14px;
        font-weight: bold;
        padding: 5px 0;
        margin: 0 !important;
        /* Removed background and border here, relying on text only */
    }
    .print-company-header hr { /* The HR under BILL */
        border: none;
        border-top: 1px dashed #000 !important;
        width: 100px;
        margin-top: 5px !important;
        margin-bottom: 5px !important;
    }

    /* --- PRINT LAYOUT FIX (Using display: table) --- */
    .print-main-content {
        display: table;
        width: 100%;
        border-collapse: collapse;
        margin: 0 !important;
    }
    .print-left-content {
        display: table-cell;
        width: 70% !important;
        padding: 10px 0 10px 15px !important; 
        vertical-align: top;
        border-right: 1px solid #000; /* Separator between details and summary */
    }
    .summary-col-print {
        display: table-cell;
        width: 30% !important;
        padding: 10px 15px 10px 10px !important; 
        vertical-align: top;
    }

    /* --- Details and Items Styling --- */
    .invoice-details-card { border: none !important; }
    .invoice-details-card .print-details-body {
        padding: 0 !important;
    }
    .print-left-content h6 {
        font-size: 13px;
        font-weight: bold;
        margin-bottom: 5px;
        text-transform: uppercase;
    }

    .items-card {
        margin-top: 10px !important;
        border: none !important;
    }
    .items-card .card-body {
        padding: 0 !important;
    }
    .print-items-table {
        margin: 0 !important;
        width: 100%;
        border-top: 1px solid #000;
        border-collapse: collapse;
    }
    .print-items-table th, .print-items-table td {
        border: 1px solid #000 !important;
        padding: 6px 8px !important;
        vertical-align: top;
        text-align: left;
        font-size: 12px;
        /* Only apply border bottom/top to create grid look */
        border-left: none !important;
        border-right: none !important;
    }
    .print-items-table th {
        background-color: #f0f0f0 !important;
        font-weight: bold;
        text-transform: uppercase;
        color: #000 !important;
    }
    .print-items-table td:nth-child(2), /* Qty */
    .print-items-table td:nth-child(3), /* Unit Price */
    .print-items-table td:nth-child(4) { /* Total Price */
        text-align: right;
    }

    /* --- Summary Card Styling (Fixed) --- */
    .summary-card-print {
        margin-top: 0 !important; /* Remove margin-top in print */
        border: none !important;
        padding: 0 !important;
        /* The container itself will not have a border, the items will */
    }
    .summary-card-print .card-body {
        padding: 0 !important;
    }
    .summary-card-print .d-flex {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px solid #000;
        width: 100%;
    }
    .summary-card-print .d-flex:first-child {
        border-top: 1px solid #000;
    }
    .summary-card-print hr {
        display: none !important; 
    }

    /* --- Bottom Info (Billed By / Thank You) --- */
    .print-bottom-info {
        padding: 15px;
        border-top: 1px solid #000;
        margin: 0 !important;
        width: 100%;
        clear: both; 
    }
    .print-bottom-info .col-md-6 {
        padding: 0 10px;
    }
</style>
{% endblock %}