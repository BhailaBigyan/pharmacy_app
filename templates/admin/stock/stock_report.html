{% extends "base.html" %}
{% block title %}Stock Report - Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3"><i class="bi bi-box-seam"></i> Stock Report</h1>
            <p class="text-muted">Comprehensive stock analysis and inventory management</p>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card">
                <div class="stat-number text-primary">{{ total_medicines }}</div>
                <div class="stat-label">Total Medicines</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card">
                <div class="stat-number text-success">{{ in_stock }}</div>
                <div class="stat-label">In Stock</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card">
                <div class="stat-number text-warning">{{ low_stock }}</div>
                <div class="stat-label">Low Stock</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card">
                <div class="stat-number text-danger">{{ out_of_stock }}</div>
                <div class="stat-label">Out of Stock</div>
            </div>
        </div>
    </div>

    <!-- Filter Options -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-funnel"></i> Filter Options</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="categoryFilter" class="form-label">Category</label>
                            <select id="categoryFilter" class="form-select">
                                <option value="">All Categories</option>
                                <option value="tablet/capsule">Tablet/Capsule</option>
                                <option value="liquid">Liquid</option>
                                <option value="patch">Patch</option>
                                <option value="cream">Topical Cream</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="stockFilter" class="form-label">Stock Status</label>
                            <select id="stockFilter" class="form-select">
                                <option value="">All</option>
                                <option value="in-stock">In Stock</option>
                                <option value="low-stock">Low Stock</option>
                                <option value="out-of-stock">Out of Stock</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="expiryFilter" class="form-label">Expiry Status</label>
                            <select id="expiryFilter" class="form-select">
                                <option value="">All</option>
                                <option value="expired">Expired</option>
                                <option value="expiring-soon">Expiring Soon</option>
                                <option value="valid">Valid</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button onclick="applyFilters()" class="btn btn-primary">
                                    <i class="bi bi-search"></i> Apply Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-table"></i> Stock Inventory</h5></div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="stockTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Brand</th>
                                    <th>Batch Number</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Mfg Date</th>
                                    <th>Exp Date</th>
                                    <th>Supplier</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for medicine in medicines %}
                                <tr>
                                    <td>{{ medicine.medicine_id }}</td>
                                    <td>{{ medicine.name }}</td>
                                    <td>{{ medicine.brand_name }}</td>
                                    <td>{{ medicine.batch_number }}</td>
                                    <td>{{ medicine.category }}</td>
                                    <td>NRS {{ medicine.price|floatformat:2 }}</td>
                                    <td>
                                        <span class="badge {% if medicine.stock_qty <= 0 %}bg-danger{% elif medicine.stock_qty <= 10 %}bg-warning{% else %}bg-success{% endif %}">
                                            {{ medicine.stock_qty }}
                                        </span>
                                    </td>
                                    <td>{{ medicine.mfg_date|date:"Y-m-d" }}</td>
                                    <td>
                                        <span class="{% if medicine.exp_date < today %}text-danger{% elif medicine.exp_date <= expiring_soon_date %}text-warning{% else %}text-success{% endif %}">
                                            {{ medicine.exp_date|date:"Y-m-d" }}
                                        </span>
                                    </td>
                                    <td>{{ medicine.supplier.name|default:"N/A" }}</td>
                                    <td>
                                        {% if medicine.stock_qty <= 0 %}
                                            <span class="badge bg-danger">Out of Stock</span>
                                        {% elif medicine.stock_qty <= 10 %}
                                            <span class="badge bg-warning">Low Stock</span>
                                        {% else %}
                                            <span class="badge bg-success">In Stock</span>
                                        {% endif %}
                                        {% if medicine.exp_date < today %}
                                            <span class="badge bg-danger ms-1">Expired</span>
                                        {% elif medicine.exp_date <= expiring_soon_date %}
                                            <span class="badge bg-warning ms-1">Expiring Soon</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="10" class="text-center text-muted">No medicines found</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- jQuery (required by DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- DataTables & Buttons (already included in your template; keep them) -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

<script>
$(document).ready(function() {
    // Parse dates from Django context (format YYYY-MM-DD). Make sure these are present in context.
    var today = new Date("{{ today|date:'Y-m-d' }}");
    var expiringSoonDate = new Date("{{ expiring_soon_date|date:'Y-m-d' }}");

    // Init DataTable with buttons including Print
    var table = $('#stockTable').DataTable({
        order: [[0, 'asc']],
        pageLength: 25,
        responsive: true,
        dom: 'Bfrtip',
        buttons: [
            { extend: 'excelHtml5', text: '<i class="bi bi-file-excel"></i> Excel', className: 'btn btn-success btn-sm' },
            { extend: 'pdfHtml5', text: '<i class="bi bi-file-pdf"></i> PDF', className: 'btn btn-danger btn-sm' },
            { extend: 'print', text: '<i class="bi bi-printer"></i> Print', className: 'btn btn-primary btn-sm',
                customize: function ( win ) {
                    // Optional: keep printed table compact and clean
                    $(win.document.body).css('font-size', '12px').prepend(
                        '<h3>Stock Inventory Report</h3><p>Printed: ' + new Date().toLocaleString() + '</p>'
                    );
                }
            }
        ]
    });

    // Helper: parse a date string (YYYY-MM-DD) into Date object ignoring timezone issues
    function parseYMD(dateStr) {
        if (!dateStr) return null;
        // trim and use split to avoid Date parsing differences
        var parts = dateStr.trim().split('-');
        if (parts.length < 3) return null;
        return new Date(parts[0], parts[1] - 1, parts[2]); // year, monthIndex, day
    }

    // Custom filter function using real values from the table rows
    $.fn.dataTable.ext.search.push(function(settings, rowData, dataIndex) {
        // Only apply to our table
        if (settings.nTable.id !== 'stockTable') return true;

        var categoryFilter = $('#categoryFilter').val(); // e.g. "tablet/capsule"
        var stockFilter = $('#stockFilter').val();       // in-stock, low-stock, out-of-stock
        var expiryFilter = $('#expiryFilter').val();     // expired, expiring-soon, valid

        // columns indexes in your table:
        // 0: ID, 1: Name, 2: Brand, 3: Batch, 4: Category, 5: Price, 6: Stock, 7: Mfg, 8: Exp Date, 9: Supplier, 10: Status

        // Get raw values from the row DOM (safer than data array because badges may contain markup)
        var rowNode = table.row(dataIndex).node();

        // Category text (column 4)
        var catText = $('td:eq(4)', rowNode).text().trim().toLowerCase();

        // Stock numeric value (column 6) - remove non-numeric
        var stockText = $('td:eq(6) span', rowNode).text().trim();
        var stockValue = parseInt(stockText.replace(/[^\d-]/g, '')) || 0;

        // Expiry date (column 8) as string (YYYY-MM-DD)
        var expText = $('td:eq(8) span', rowNode).text().trim();
        // Try parsing; if template prints as 'YYYY-MM-DD' this will work
        var expDate = parseYMD(expText);

        // ----- Category Filter -----
        if (categoryFilter) {
            // normalize both sides
            if (catText !== categoryFilter.toLowerCase()) {
                return false;
            }
        }

        // ----- Stock Filter -----
        if (stockFilter) {
            if (stockFilter === 'in-stock' && stockValue <= 10) return false;
            if (stockFilter === 'low-stock' && (stockValue === 0 || stockValue > 10)) return false;
            if (stockFilter === 'out-of-stock' && stockValue !== 0) return false;
        }

        // ----- Expiry Filter -----
        if (expiryFilter) {
            var isExpired = false;
            var isExpiringSoon = false;
            var isValid = false;

            if (expDate) {
                // compare dates ignoring time
                var exp = new Date(expDate.getFullYear(), expDate.getMonth(), expDate.getDate());
                var td = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                var esd = new Date(expiringSoonDate.getFullYear(), expiringSoonDate.getMonth(), expiringSoonDate.getDate());

                if (exp < td) {
                    isExpired = true;
                } else if (exp <= esd) {
                    isExpiringSoon = true;
                } else {
                    isValid = true;
                }
            } else {
                // if expiry not parseable, treat as valid (or change logic as needed)
                isValid = true;
            }

            if (expiryFilter === 'expired' && !isExpired) return false;
            if (expiryFilter === 'expiring-soon' && !isExpiringSoon) return false;
            if (expiryFilter === 'valid' && !isValid) return false;
        }

        // passed all filters
        return true;
    });

    // Apply filters (redraw table)
    window.applyFilters = function() {
        table.draw();
    };

    // Live apply on change
    $('#categoryFilter, #stockFilter, #expiryFilter').on('change', function() {
        applyFilters();
    });

    // Optional: reset filters button (if present) - keeps UX
    // $('#resetFiltersBtn').on('click', function() { $('#categoryFilter, #stockFilter, #expiryFilter').val(''); applyFilters(); });

    // Ensure initial draw applies filters (if template preselects anything)
    table.draw();
});
</script>

{% endblock %}
