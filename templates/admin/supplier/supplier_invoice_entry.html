{% extends 'base.html' %}
{% block content %}
<h3>Supplier Invoice Entry</h3>
{%csrf_token%}
<form id="supplierInvoiceForm">
    <select name="supplierId" id="supplierSelect">
        {% for supplier in suppliers %}
        <option value="{{ supplier.id }}">{{ supplier.name }}</option>
        {% endfor %}
        <option value="new">+ Add New Supplier</option>
    </select>


    <input type="text" name="invoiceNumber" placeholder="Invoice Number" required>
    <input type="date" name="date" id="date">
    <div id="itemsContainer"></div>
    <button type="button" onclick="addItem()">Add Item</button>

    <button type="submit">Save Invoice</button>
</form>

<script>
    document.getElementById('supplierSelect').addEventListener('change', function () {
        if (this.value === 'new') {
            window.location.href = "{% url 'add_supplier' %}";
        }
    });
</script>

<script>
    function addItem() {
        const container = document.getElementById('itemsContainer');
        const div = document.createElement('div');
        div.classList.add('item-row', 'mb-2');
        div.innerHTML = `
        <hr>
        <input type="text" name="name" placeholder="Medicine Name" required>
        <input type="text" name="brand_name" placeholder="Brand Name" required>
        <input type="text" name="batch_number" placeholder="Batch Number">
        <select name="category" required>
            <option value="tablet/capsule">Tablet/Capsule</option>
            <option value="liquid">Liquid</option>
            <option value="patch">Patch</option>
            <option value="cream">Topical Cream</option>
        </select>
        <input type="date" name="mfg_date" placeholder="Mfg Date" required>
        <input type="date" name="exp_date" placeholder="Exp Date" required>
        <input type="number" name="quantity" placeholder="Quantity" min="1" required>
        <input type="number" name="price" placeholder="Price" step="0.01" min="0" required>
        <button type="button" onclick="this.parentElement.remove()">❌</button>
    `;
        container.appendChild(div);
    }

    document.getElementById('supplierInvoiceForm').addEventListener('submit', async function(e){
    e.preventDefault();

    const items = [];
    document.querySelectorAll('#itemsContainer > div').forEach(div => {
        items.push({
            name: div.querySelector('input[name="name"]').value,
            brand_name: div.querySelector('input[name="brand_name"]').value,
            batch_number: div.querySelector('input[name="batch_number"]').value,
            category: div.querySelector('select[name="category"]').value,
            mfg_date: div.querySelector('input[name="mfg_date"]').value,
            exp_date: div.querySelector('input[name="exp_date"]').value,
            quantity: div.querySelector('input[name="quantity"]').value,
            price: div.querySelector('input[name="price"]').value,
        });
    });

    const data = {
        supplierId: document.getElementById('supplierSelect').value,
        invoiceNumber: this.invoiceNumber.value,
        items: items
    };

    const response = await fetch("{% url 'create_supplier_invoice' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    });

    const res = await response.json();
    if (res.invoice_id) {
        alert('✅ Invoice saved successfully and medicine stock updated!');
        location.reload();
    } else {
        alert('❌ Error: ' + res.error);
        console.log(res);
    }
});

</script>
{% endblock %}