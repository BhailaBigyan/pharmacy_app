{% extends 'base.html' %}
{% block content %}
<h3>Supplier Invoice Entry</h3>

<form id="supplierInvoiceForm">
   <select name="supplierId" id="supplierSelect">
    {% for supplier in suppliers %}
    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
    {% endfor %}
    <option value="new">+ Add New Supplier</option>
</select>


    <input type="text" name="invoiceNumber" placeholder="Invoice Number" required>
    <input type="date" name="date" id="date">
    <div id="itemsContainer"></div>
    <button type="button" onclick="addItem()">Add Item</button>

    <button type="submit">Save Invoice</button>
</form>

<script>
document.getElementById('supplierSelect').addEventListener('change', function() {
    if (this.value === 'new') {
        window.location.href = "{% url 'add_supplier' %}";
    }
});
</script>

<script>
function addItem() {
    const container = document.getElementById('itemsContainer');
    const div = document.createElement('div');
   div.innerHTML = `
    <input type="text" name="name" placeholder="Medicine Name">
    <input type="text" name="brand_name" placeholder="Brand Name">
    <input type="number" name="quantity" placeholder="Quantity" required>
    <input type="number" name="price" placeholder="Price" step="0.01" required>
`;

    container.appendChild(div);
}

document.getElementById('supplierInvoiceForm').addEventListener('submit', function(e){
    e.preventDefault();
    const items = [];
    document.querySelectorAll('#itemsContainer > div').forEach(div => {
        items.push({
            id: div.querySelector('select[name="itemId"]').value,
            quantity: div.querySelector('input[name="quantity"]').value,
            price: div.querySelector('input[name="price"]').value,
        });
    });

    const data = {
        supplierId: this.supplierId.value,
        invoiceNumber: this.invoiceNumber.value,
        items: items
    };

    fetch("{% url 'create_supplier_invoice' %}", {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(res => {
        if(res.invoice_id) alert('Invoice saved and stock updated!');
        else alert('Error: ' + res.error);
    });
});
</script>
{% endblock %}
