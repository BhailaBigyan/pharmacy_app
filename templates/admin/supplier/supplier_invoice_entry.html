{% extends 'base.html' %}
{% block content %}
<<<<<<< Updated upstream
<h3>Supplier Invoice Entry</h3>

<form id="supplierInvoiceForm">
   <select name="supplierId" id="supplierSelect">
    {% for supplier in suppliers %}
    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
    {% endfor %}
    <option value="new">+ Add New Supplier</option>
</select>


    <input type="text" name="invoiceNumber" placeholder="Invoice Number" required>
    <input type="date" name="date" id="date">
    <div id="itemsContainer"></div>
    <button type="button" onclick="addItem()">Add Item</button>

    <button type="submit">Save Invoice</button>
</form>

<script>
document.getElementById('supplierSelect').addEventListener('change', function() {
    if (this.value === 'new') {
        window.location.href = "{% url 'add_supplier' %}";
    }
});
</script>

<script>
function addItem() {
    const container = document.getElementById('itemsContainer');
    const div = document.createElement('div');
   div.innerHTML = `
    <input type="text" name="name" placeholder="Medicine Name">
    <input type="text" name="brand_name" placeholder="Brand Name">
    <input type="number" name="quantity" placeholder="Quantity" required>
    <input type="number" name="price" placeholder="Price" step="0.01" required>
`;

    container.appendChild(div);
}

document.getElementById('supplierInvoiceForm').addEventListener('submit', function(e){
    e.preventDefault();
    const items = [];
    document.querySelectorAll('#itemsContainer > div').forEach(div => {
        items.push({
            id: div.querySelector('select[name="itemId"]').value,
            quantity: div.querySelector('input[name="quantity"]').value,
            price: div.querySelector('input[name="price"]').value,
        });
    });

    const data = {
        supplierId: this.supplierId.value,
        invoiceNumber: this.invoiceNumber.value,
        items: items
    };

    fetch("{% url 'create_supplier_invoice' %}", {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(res => {
        if(res.invoice_id) alert('Invoice saved and stock updated!');
        else alert('Error: ' + res.error);
    });
=======
<h2>Supplier Invoice</h2>

<form id="supplierInvoiceForm" class="card p-3" style="max-width: 1000px;">
  <div class="row g-3">
    <div class="col-md-4">
      <label class="form-label">Supplier</label>
      <select class="form-select" name="supplierId" id="supplierSelect">
        {% for supplier in suppliers %}
        <option value="{{ supplier.id }}">{{ supplier.name }}</option>
        {% endfor %}
        <option value="new">+ Add New Supplier</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Invoice #</label>
      <input class="form-control" type="text" name="invoiceNumber" id="invoiceNumber" readonly>
    </div>
    <div class="col-md-2">
      <label class="form-label">Date</label>
      <input class="form-control" type="date" name="date" id="date">
    </div>
    <div class="col-md-4">
      <label class="form-label">Medicine Type</label>
      <select class="form-select" name="medicineType" id="medicineTypeSelect">
        <option value="existing">Existing Medicine</option>
        <option value="new">New Medicine</option>
      </select>
    </div>
  </div>

  <div class="table-responsive mt-4">
    <table class="table table-bordered align-middle" id="itemsTable">
      <thead class="table-light">
        <tr>
          <th style="width: 120px;">ID/Name</th>
          <th>Details</th>
          <th style="width: 140px;">Batch #</th>
          <th style="width: 120px;">Qty</th>
          <th style="width: 140px;">Unit Price</th>
          <th style="width: 140px;">Total</th>
          <th style="width: 60px;"></th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="5" class="text-end"><strong>Grand Total</strong></td>
          <td><strong id="grandTotal">0.00</strong></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="mt-2">
    <button class="btn btn-outline-primary" type="button" onclick="addItem()">Add Item</button>
  </div>

  <div class="mt-4">
    <button class="btn btn-success" type="submit">Save Invoice</button>
  </div>
</form>

<script>
// Auto-generate invoice number and set today's date
document.addEventListener('DOMContentLoaded', function() {
  // Set today's date
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('date').value = today;
  
  // Generate next invoice number
  fetch("{% url 'get_next_invoice_number' %}")
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('invoiceNumber').value = data.invoice_number;
      }
    });
});

document.getElementById('supplierSelect').addEventListener('change', function() {
  if (this.value === 'new') {
    window.location.href = "{% url 'add_supplier' %}";
  }
});

function addItem() {
  const tbody = document.querySelector('#itemsTable tbody');
  const medicineType = document.getElementById('medicineTypeSelect').value;
  const tr = document.createElement('tr');
  
  if (medicineType === 'existing') {
    tr.innerHTML = `
      <td><input class="form-control form-control-sm" type="number" name="medicineId" placeholder="Enter Medicine ID" required onblur="loadMedicine(this)"></td>
      <td class="text-muted small" data-name="name">(enter ID to load)</td>
      <td><input class="form-control form-control-sm" type="text" name="batchNumber"></td>
      <td><input class="form-control form-control-sm" type="number" name="quantity" min="1" value="1" required oninput="recalc()"></td>
      <td><input class="form-control form-control-sm" type="number" name="price" step="0.01" value="0" required oninput="recalc()"></td>
      <td class="itemTotal">0.00</td>
      <td><button class="btn btn-sm btn-outline-danger" type="button" onclick="removeRow(this)">✕</button></td>`;
  } else {
    tr.innerHTML = `
      <td><input class="form-control form-control-sm" type="text" name="newMedicineName" placeholder="Medicine Name" required></td>
      <td><input class="form-control form-control-sm" type="text" name="newBrandName" placeholder="Brand Name"></td>
      <td><input class="form-control form-control-sm" type="text" name="batchNumber"></td>
      <td><input class="form-control form-control-sm" type="number" name="quantity" min="1" value="1" required oninput="recalc()"></td>
      <td><input class="form-control form-control-sm" type="number" name="price" step="0.01" value="0" required oninput="recalc()"></td>
      <td class="itemTotal">0.00</td>
      <td><button class="btn btn-sm btn-outline-danger" type="button" onclick="removeRow(this)">✕</button></td>`;
  }
  
  tbody.appendChild(tr);
}

function loadMedicine(input) {
  const medId = input.value;
  if (!medId) return;
  
  const row = input.closest('tr');
  const nameCell = row.querySelector('[data-name="name"]');
  const priceInput = row.querySelector('input[name="price"]');
  
  fetch(`/supplier/api/medicine/${medId}/`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        nameCell.textContent = data.medicine.name;
        priceInput.value = parseFloat(data.medicine.price).toFixed(2);
        recalc();
      } else {
        nameCell.textContent = '(not found)';
        priceInput.value = '0';
      }
    })
    .catch(() => {
      nameCell.textContent = '(error loading)';
      priceInput.value = '0';
    });
}

function removeRow(btn) {
  const tr = btn.closest('tr');
  tr.remove();
  recalc();
}

function recalc() {
  const rows = document.querySelectorAll('#itemsTable tbody tr');
  let grand = 0;
  rows.forEach(row => {
    const qty = parseFloat(row.querySelector('input[name="quantity"]').value || '0');
    const price = parseFloat(row.querySelector('input[name="price"]').value || '0');
    const total = qty * price;
    row.querySelector('.itemTotal').innerText = total.toFixed(2);
    grand += total;
  });
  document.getElementById('grandTotal').innerText = grand.toFixed(2);
}

document.getElementById('supplierInvoiceForm').addEventListener('submit', function(e){
  e.preventDefault();
  const items = [];
  const medicineType = document.getElementById('medicineTypeSelect').value;
  
  document.querySelectorAll('#itemsTable tbody tr').forEach(row => {
    const item = {
      batchNumber: row.querySelector('input[name="batchNumber"]').value,
      quantity: row.querySelector('input[name="quantity"]').value,
      price: row.querySelector('input[name="price"]').value,
    };
    
    if (medicineType === 'existing') {
      item.medicineId = row.querySelector('input[name="medicineId"]').value;
    } else {
      item.newMedicineName = row.querySelector('input[name="newMedicineName"]').value;
      item.newBrandName = row.querySelector('input[name="newBrandName"]').value;
    }
    
    items.push(item);
  });

  const data = {
    supplierId: this.supplierId.value,
    invoiceNumber: this.invoiceNumber.value,
    date: this.date.value,
    receivedBy: '{{ request.user.username|default:"system" }}',
    items: items
  };

  fetch("{% url 'create_supplier_invoice' %}", {
    method: 'POST',
    headers: {'Content-Type':'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(res => {
    if(res.invoice_id) {
      alert('Invoice saved and stock updated!');
      window.location.reload();
    } else {
      alert('Error: ' + res.error);
    }
  });
>>>>>>> Stashed changes
});
</script>
{% endblock %}
